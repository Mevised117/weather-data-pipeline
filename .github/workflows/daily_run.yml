name: Daily Weather Pipeline

# 1. ตั้งเวลาทำงาน (Trigger)
on:
  # รันทุกครั้งที่มีการแก้ไขโค้ดใน branch main (เพิ่มตรงนี้)
  push:
    branches: [ "main" ]
  schedule:
    # รันทุกวันตอน 7:00 น. ประเทศไทย (คือ 00:00 UTC)
    - cron: '0 0 * * *'
  # อนุญาตให้กดรันมือได้ด้วย (เอาไว้เทส)
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest # ใช้เครื่อง Ubuntu

    steps:
      # 2. ดึงโค้ดมาจาก Repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 3. ติดตั้ง Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 4. สร้างไฟล์ key.json ขึ้นมาใหม่ (โดยอ่านจากความลับที่ซ่อนไว้)
      - name: Create Service Account Key
        run: echo "${{ secrets.GCP_KEY_JSON }}" > key.json

      # 5. ลง Library ที่จำเป็น
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6. รันโค้ด ETL ของเรา
      - name: Run ETL Script
        run: python etl_weather.py